with min_fee_tab(report_date,start_time,end_time,city_id,min_fee) as 
(VALUES
(date'2024-02-04',600,1029,217,13500),
(date'2024-02-04',1030,1230,217,15000),
(date'2024-02-04',1231,1659,217,13500),
(date'2024-02-04',1700,2000,217,15000),
(date'2024-02-04',2001,2200,217,13500),
(date'2024-02-04',600,1029,218,13500),
(date'2024-02-04',1030,1230,218,15000),
(date'2024-02-04',1231,1659,218,13500),
(date'2024-02-04',1700,2000,218,15000),
(date'2024-02-04',2001,2200,218,13500),
(date'2024-02-04',600,1029,220,13500),
(date'2024-02-04',1030,1230,220,15000),
(date'2024-02-04',1231,1659,220,13500),
(date'2024-02-04',1700,2000,220,15000),
(date'2024-02-04',2001,2200,220,13500),
(date'2024-02-05',600,1029,217,13500),
(date'2024-02-05',1030,1230,217,15000),
(date'2024-02-05',1231,1659,217,13500),
(date'2024-02-05',1700,2000,217,15000),
(date'2024-02-05',2001,2200,217,13500),
(date'2024-02-05',600,1029,218,13500),
(date'2024-02-05',1030,1230,218,15000),
(date'2024-02-05',1231,1659,218,13500),
(date'2024-02-05',1700,2000,218,15000),
(date'2024-02-05',2001,2200,218,13500),
(date'2024-02-05',600,1029,220,13500),
(date'2024-02-05',1030,1230,220,15000),
(date'2024-02-05',1231,1659,220,13500),
(date'2024-02-05',1700,2000,220,15000),
(date'2024-02-05',2001,2200,220,13500),
(date'2024-02-05',600,1029,217,13500),
(date'2024-02-06',600,1029,217,15000),
(date'2024-02-06',1030,1230,217,16000),
(date'2024-02-06',1231,1659,217,15000),
(date'2024-02-06',1700,2000,217,16000),
(date'2024-02-06',2001,2200,217,15000),
(date'2024-02-06',600,1029,218,15000),
(date'2024-02-06',1030,1230,218,16000),
(date'2024-02-06',1231,1659,218,15000),
(date'2024-02-06',1700,2000,218,16000),
(date'2024-02-06',2001,2200,218,15000),
(date'2024-02-06',600,1029,220,14000),
(date'2024-02-06',1030,1230,220,15000),
(date'2024-02-06',1231,1659,220,14000),
(date'2024-02-06',1700,2000,220,15000),
(date'2024-02-06',2001,2200,220,14000),
(date'2024-02-07',600,1029,217,15000),
(date'2024-02-07',1030,1230,217,16000),
(date'2024-02-07',1231,1659,217,15000),
(date'2024-02-07',1700,2000,217,16000),
(date'2024-02-07',2001,2200,217,15000),
(date'2024-02-07',600,1029,218,15000),
(date'2024-02-07',1030,1230,218,16000),
(date'2024-02-07',1231,1659,218,15000),
(date'2024-02-07',1700,2000,218,16000),
(date'2024-02-07',2001,2200,218,15000),
(date'2024-02-07',600,1029,220,14000),
(date'2024-02-07',1030,1230,220,15000),
(date'2024-02-07',1231,1659,220,14000),
(date'2024-02-07',1700,2000,220,15000),
(date'2024-02-07',2001,2200,220,14000),
(date'2024-02-08',600,1029,217,18500),
(date'2024-02-08',1030,1230,217,20000),
(date'2024-02-08',1231,1659,217,18500),
(date'2024-02-08',1700,2000,217,20000),
(date'2024-02-08',2001,2200,217,18500),
(date'2024-02-08',600,1029,218,18500),
(date'2024-02-08',1030,1230,218,20000),
(date'2024-02-08',1231,1659,218,18500),
(date'2024-02-08',1700,2000,218,20000),
(date'2024-02-08',2001,2200,218,18500),
(date'2024-02-08',600,1029,220,17000),
(date'2024-02-08',1030,1230,220,18000),
(date'2024-02-08',1231,1659,220,17000),
(date'2024-02-08',1700,2000,220,18000),
(date'2024-02-08',2001,2200,220,17000),
(date'2024-02-09',600,1029,217,18500),
(date'2024-02-09',1030,1230,217,22000),
(date'2024-02-09',1231,1659,217,18500),
(date'2024-02-09',1700,2000,217,22000),
(date'2024-02-09',2001,2200,217,18500),
(date'2024-02-09',600,1029,218,18500),
(date'2024-02-09',1030,1230,218,22000),
(date'2024-02-09',1231,1659,218,18500),
(date'2024-02-09',1700,2000,218,22000),
(date'2024-02-09',2001,2200,218,18500),
(date'2024-02-09',600,1029,220,17000),
(date'2024-02-09',1030,1230,220,18000),
(date'2024-02-09',1231,1659,220,17000),
(date'2024-02-09',1700,2000,220,18000),
(date'2024-02-09',2001,2200,220,17000),
(date'2024-02-10',600,1029,217,18500),
(date'2024-02-10',1030,1230,217,22000),
(date'2024-02-10',1231,1659,217,18500),
(date'2024-02-10',1700,2000,217,22000),
(date'2024-02-10',2001,2200,217,18500),
(date'2024-02-10',600,1029,218,18500),
(date'2024-02-10',1030,1230,218,22000),
(date'2024-02-10',1231,1659,218,18500),
(date'2024-02-10',1700,2000,218,22000),
(date'2024-02-10',2001,2200,218,18500),
(date'2024-02-10',600,1029,220,17000),
(date'2024-02-10',1030,1230,220,18000),
(date'2024-02-10',1231,1659,220,17000),
(date'2024-02-10',1700,2000,220,18000),
(date'2024-02-10',2001,2200,220,17000),
(date'2024-02-11',600,1029,217,18500),
(date'2024-02-11',1030,1230,217,22000),
(date'2024-02-11',1231,1659,217,18500),
(date'2024-02-11',1700,2000,217,22000),
(date'2024-02-11',2001,2200,217,18500),
(date'2024-02-11',600,1029,218,18500),
(date'2024-02-11',1030,1230,218,22000),
(date'2024-02-11',1231,1659,218,18500),
(date'2024-02-11',1700,2000,218,22000),
(date'2024-02-11',2001,2200,218,18500),
(date'2024-02-11',600,1029,220,17000),
(date'2024-02-11',1030,1230,220,18000),
(date'2024-02-11',1231,1659,220,17000),
(date'2024-02-11',1700,2000,220,18000),
(date'2024-02-11',2001,2200,220,17000),
(date'2024-02-12',600,1029,217,18500),
(date'2024-02-12',1030,1230,217,22000),
(date'2024-02-12',1231,1659,217,18500),
(date'2024-02-12',1700,2000,217,22000),
(date'2024-02-12',2001,2200,217,18500),
(date'2024-02-12',600,1029,218,18500),
(date'2024-02-12',1030,1230,218,22000),
(date'2024-02-12',1231,1659,218,18500),
(date'2024-02-12',1700,2000,218,22000),
(date'2024-02-12',2001,2200,218,18500),
(date'2024-02-12',600,1029,220,17000),
(date'2024-02-12',1030,1230,220,18000),
(date'2024-02-12',1231,1659,220,17000),
(date'2024-02-12',1700,2000,220,18000),
(date'2024-02-12',2001,2200,220,17000),
(date'2024-02-13',600,1029,217,18500),
(date'2024-02-13',1030,1230,217,20000),
(date'2024-02-13',1231,1659,217,18500),
(date'2024-02-13',1700,2000,217,20000),
(date'2024-02-13',2001,2200,217,18500),
(date'2024-02-13',600,1029,218,18500),
(date'2024-02-13',1030,1230,218,20000),
(date'2024-02-13',1231,1659,218,18500),
(date'2024-02-13',1700,2000,218,20000),
(date'2024-02-13',2001,2200,218,18500),
(date'2024-02-13',600,1029,220,17000),
(date'2024-02-13',1030,1230,220,18000),
(date'2024-02-13',1231,1659,220,17000),
(date'2024-02-13',1700,2000,220,18000),
(date'2024-02-13',2001,2200,220,17000),
(date'2024-02-14',600,1029,217,18500),
(date'2024-02-14',1030,1230,217,20000),
(date'2024-02-14',1231,1659,217,18500),
(date'2024-02-14',1700,2000,217,20000),
(date'2024-02-14',2001,2200,217,18500),
(date'2024-02-14',600,1029,218,18500),
(date'2024-02-14',1030,1230,218,20000),
(date'2024-02-14',1231,1659,218,18500),
(date'2024-02-14',1700,2000,218,20000),
(date'2024-02-14',2001,2200,218,18500),
(date'2024-02-14',600,1029,220,17000),
(date'2024-02-14',1030,1230,220,18000),
(date'2024-02-14',1231,1659,220,17000),
(date'2024-02-14',1700,2000,220,18000),
(date'2024-02-14',2001,2200,220,17000),
(date'2024-02-15',600,1029,217,13500),
(date'2024-02-15',1030,1230,217,15000),
(date'2024-02-15',1231,1659,217,13500),
(date'2024-02-15',1700,2000,217,15000),
(date'2024-02-15',2001,2200,217,13500),
(date'2024-02-15',600,1029,218,13500),
(date'2024-02-15',1030,1230,218,15000),
(date'2024-02-15',1231,1659,218,13500),
(date'2024-02-15',1700,2000,218,15000),
(date'2024-02-15',2001,2200,218,13500),
(date'2024-02-15',600,1029,220,13500),
(date'2024-02-15',1030,1230,220,14000),
(date'2024-02-15',1231,1659,220,13500),
(date'2024-02-15',1700,2000,220,14000),
(date'2024-02-15',2001,2200,220,13500),
(date'2024-02-16',600,1029,217,13500),
(date'2024-02-16',1030,1230,217,15000),
(date'2024-02-16',1231,1659,217,13500),
(date'2024-02-16',1700,2000,217,15000),
(date'2024-02-16',2001,2200,217,13500),
(date'2024-02-16',600,1029,218,13500),
(date'2024-02-16',1030,1230,218,15000),
(date'2024-02-16',1231,1659,218,13500),
(date'2024-02-16',1700,2000,218,15000),
(date'2024-02-16',2001,2200,218,13500),
(date'2024-02-16',600,1029,220,13500),
(date'2024-02-16',1030,1230,220,14000),
(date'2024-02-16',1231,1659,220,13500),
(date'2024-02-16',1700,2000,220,14000),
(date'2024-02-16',2001,2200,220,13500)
)
-- # Replace logic last_incharged_timestamp to last_auto_assign_time
select a.* 
from
(select
        raw.id as ref_id,
        raw.shipper_id,
        raw.city_name,
        raw.created_date,
        date(raw.delivered_timestamp) as report_date,
        coalesce(raw.last_incharge_timestamp,raw.created_timestamp) as last_incharge_timestamp,
        raw.first_auto_assign_timestamp,
        raw.late_night_service_fee,
        raw.holiday_service_fee,
        raw.holiday_service_fee + 13500 as shipping_received,
        mf.min_fee as shipping_fee_expected,
        case 
        when (mf.min_fee - (raw.holiday_service_fee + 13500)) < 0 then 0 
        else (mf.min_fee - (raw.holiday_service_fee + 13500))  end as adjustment,
        date(from_unixtime(d.autopay_date_ts -3600)) as autopay_date_ts,
        (HOUR(raw.last_incharge_timestamp)*100 + MINUTE(raw.first_auto_assign_timestamp)) as hm 



from driver_ops_raw_order_tab raw

left join shopeefood.foody_partner_archive_db__shipper_hub_order_tab__reg_continuous_s0_live d 
    on d.ref_order_id = raw.id

left join min_fee_tab mf 
    on mf.city_id = raw.city_id
    and mf.report_date = date(raw.last_incharge_timestamp)
    and (HOUR(coalesce(raw.last_incharge_timestamp,raw.created_timestamp))*100 + MINUTE(coalesce(raw.last_incharge_timestamp,raw.created_timestamp))) >= mf.start_time 
    and (HOUR(coalesce(raw.last_incharge_timestamp,raw.created_timestamp))*100 + MINUTE(coalesce(raw.last_incharge_timestamp,raw.created_timestamp))) < mf.end_time

where raw.driver_policy = 2
and raw.order_type = 0
and raw.order_status = 'Delivered'
and date(coalesce(raw.last_incharge_timestamp,raw.created_timestamp)) between date'2024-02-04' and date'2024-02-16'
and late_night_service_fee = 0
) a 
left join shopeefood_vn_tet_holiday_min_fee_tab b on b.order_id = a.ref_id and b.diff > 0 

where a.autopay_date_ts is not null 
-- and ref_id = 729110625
and a.report_date = autopay_date_ts
and b.order_id is null
and a.adjustment > 0 
;
